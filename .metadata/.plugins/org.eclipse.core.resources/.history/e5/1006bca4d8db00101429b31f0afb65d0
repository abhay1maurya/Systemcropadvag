/* =========================================================
   KRISHI SAHAYAK BLOG - FINAL JS
   Farmer’s Corner + Expert Insights (Separated Logic)
   ========================================================= */

let blogPostsData = [];
let currentActivePostId = null;

/* ================= DOM READY ================= */
document.addEventListener("DOMContentLoaded", () => {
    initDataModel();
    initHeader();
    initMobileMenu();
    initLanguageToggle();
    initProfileModal();

    initFarmersCornerLoadMore();   // ✅ ONLY Farmer’s Corner
    showExpertInsightsAlways();    // ✅ ALWAYS visible

    initCategoryFilter();          // ✅ Farmer’s Corner only
    initSearchFunctionality();     // ✅ Farmer’s Corner only

    initCardInteractions();
    initArticleModalLogic();
    initNewsletter();
    initCreatePost();
});

/* ================= SAFE HELPERS ================= */
const safeText = (p, s) => p.querySelector(s)?.innerText.trim() || "";
const safeSrc  = (p, s) => p.querySelector(s)?.src || "";

/* ================= DATA MODEL ================= */
function initDataModel() {
    document.querySelectorAll(".farmer-post").forEach((card, index) => {
        const id = `farmer-post-${index}`;
        card.dataset.id = id;

        const stats = card.querySelectorAll(".blog-post-stats span");

        blogPostsData.push({
            id,
            title: safeText(card, ".blog-post-title"),
            excerpt: safeText(card, ".blog-post-excerpt"),
            content: `<p>${safeText(card, ".blog-post-excerpt")}</p>`,
            image: safeSrc(card, ".blog-post-image img"),
            author: {
                name: safeText(card, ".blog-post-author h6"),
                role: safeText(card, ".blog-post-author span"),
                img: safeSrc(card, ".blog-author-img")
            },
            stats: {
                likes: parseInt(stats[0]?.innerText.replace(/\D/g, "")) || 0,
                comments: parseInt(stats[1]?.innerText.replace(/\D/g, "")) || 0,
                isLiked: false
            },
            comments: []
        });
    });
}

/* ================= HEADER ================= */
function initHeader() {
    const header = document.querySelector(".blog-header-section");
    window.addEventListener("scroll", () => {
        header.style.boxShadow =
            window.scrollY > 50
                ? "0 4px 15px rgba(0,0,0,.15)"
                : "0 2px 15px rgba(0,0,0,.05)";
    });
}

/* ================= MOBILE MENU ================= */
function initMobileMenu() {
    const toggle = document.getElementById("mobileToggle");
    const menu = document.getElementById("mobileMenu");

    toggle?.addEventListener("click", () => {
        menu.classList.toggle("active");
        document.body.style.overflow = menu.classList.contains("active") ? "hidden" : "";
        toggle.querySelector("i").className =
            menu.classList.contains("active") ? "fas fa-times" : "fas fa-bars";
    });
}

/* ================= LANGUAGE ================= */
function initLanguageToggle() {
    const wrapper = document.getElementById("modernLangToggle");
    if (!wrapper) return;

    wrapper.querySelector(".modern-lang-btn").onclick = e => {
        e.stopPropagation();
        wrapper.classList.toggle("active");
    };

    document.addEventListener("click", () => wrapper.classList.remove("active"));
}

/* ================= PROFILE ================= */
function initProfileModal() {
    const wrapper = document.querySelector(".blog-profile-wrapper");
    const btn = document.getElementById("profileBtn");

    btn?.addEventListener("click", e => {
        e.stopPropagation();
        wrapper.classList.toggle("active");
    });

    document.addEventListener("click", () => wrapper?.classList.remove("active"));
}

/* =========================================================
   FARMER’S CORNER LOAD MORE (MAIN REQUIREMENT)
   ========================================================= */
function initFarmersCornerLoadMore() {
    const farmerPosts = Array.from(document.querySelectorAll(".farmer-post"));
    const loadMoreBtn = document.getElementById("loadMoreBtn");

    const STEP = 3;
    let visible = STEP;

    // Initial display
    farmerPosts.forEach((post, index) => {
        post.style.display = index < visible ? "block" : "none";
    });

    // Hide button if not needed
    if (farmerPosts.length <= STEP) {
        loadMoreBtn.style.display = "none";
        return;
    }

    loadMoreBtn.addEventListener("click", () => {
        visible += STEP;

        farmerPosts.forEach((post, index) => {
            if (index < visible) post.style.display = "block";
        });

        // Hide when all visible
        if (visible >= farmerPosts.length) {
            loadMoreBtn.style.display = "none";
        }
    });
}

/* ================= EXPERT INSIGHTS ================= */
function showExpertInsightsAlways() {
    document.querySelectorAll(".expert-post").forEach(post => {
        post.style.display = "block";
    });
}

/* ================= CATEGORY FILTER (Farmer only) ================= */
function initCategoryFilter() {
    const categories = document.querySelectorAll(".blog-category-card");
    const farmerPosts = document.querySelectorAll(".farmer-post");

    categories.forEach(cat => {
        cat.addEventListener("click", () => {
            categories.forEach(c => c.classList.remove("active"));
            cat.classList.add("active");

            const key = cat.innerText.toLowerCase();

            farmerPosts.forEach(post => {
                const postCat = post.dataset.category || "";
                post.style.display =
                    key.includes("all") || postCat.includes(key)
                        ? "block"
                        : "none";
            });
        });
    });
}

/* ================= SEARCH (Farmer only) ================= */
function initSearchFunctionality() {
    const input = document.querySelector(".blog-search-box input");
    const btn = document.querySelector(".blog-search-btn");
    const farmerPosts = document.querySelectorAll(".farmer-post");

    const search = () => {
        const term = input.value.toLowerCase();
        farmerPosts.forEach(post => {
            post.style.display =
                post.innerText.toLowerCase().includes(term)
                    ? "block"
                    : "none";
        });
    };

    btn?.addEventListener("click", search);
    input?.addEventListener("keyup", e => e.key === "Enter" && search());
}

/* ================= CARD INTERACTIONS ================= */
function initCardInteractions() {
    document.querySelectorAll(".farmer-post, .expert-post").forEach(card => {
        const id = card.dataset.id;

        card.addEventListener("click", e => {
            if (!e.target.closest(".blog-post-stats")) {
                if (id) openArticleModal(id);
            }
        });

        card.querySelector(".blog-read-btn")?.addEventListener("click", e => {
            e.stopPropagation();
            if (id) openArticleModal(id);
        });
    });
}

/* ================= ARTICLE MODAL ================= */
function initArticleModalLogic() {
    const modal = document.getElementById("articleModal");
    if (!modal) return;

    modal.querySelector(".blog-modal-close").onclick = closeModal;
    modal.onclick = e => e.target === modal && closeModal();
}

function openArticleModal(id) {
    const post = blogPostsData.find(p => p.id === id);
    if (!post) return;

    currentActivePostId = id;

    document.getElementById("modalArticleTitle").innerText = post.title;
    document.getElementById("modalArticleContent").innerHTML = post.content;
    document.getElementById("modalAuthorName").innerText = post.author.name;
    document.getElementById("modalAuthorRole").innerText = post.author.role;
    document.getElementById("modalAuthorImg").src = post.author.img;

    document.getElementById("articleModal").classList.add("active");
    document.body.style.overflow = "hidden";
}

function closeModal() {
    document.getElementById("articleModal").classList.remove("active");
    document.body.style.overflow = "";
}

/* ================= NEWSLETTER ================= */
function initNewsletter() {
    document
        .querySelectorAll(".blog-newsletter-form, .blog-footer-newsletter")
        .forEach(form => {
            form.addEventListener("submit", e => {
                e.preventDefault();
                alert("Subscribed successfully!");
                form.reset();
            });
        });
}


document.addEventListener("DOMContentLoaded", () => {

  const modal = document.getElementById("articleModal");
  const closeBtn = modal.querySelector(".blog-modal-close");

  const modalTitle = document.getElementById("modalArticleTitle");
  const modalContent = document.getElementById("modalArticleContent");
  const modalImage = document.getElementById("modalPostImage");
  const modalAuthor = document.getElementById("modalAuthorName");
  const modalRole = document.getElementById("modalAuthorRole");
  const modalAuthorImg = document.getElementById("modalAuthorImg");

  document.querySelectorAll(".blog-read-btn").forEach(btn => {
    btn.addEventListener("click", () => {

      modalTitle.textContent = btn.dataset.title || "Post";
      modalContent.textContent = btn.dataset.content || "";

      if (btn.dataset.image) {
        modalImage.src = btn.dataset.image;
        modalImage.style.display = "block";
      } else {
        modalImage.style.display = "none";
      }

      modalAuthor.textContent = btn.dataset.author || "Author";
      modalRole.textContent = btn.dataset.role || "";
      modalAuthorImg.src = "https://randomuser.me/api/portraits/men/85.jpg";

      modal.classList.add("active");
      document.body.style.overflow = "hidden";
    });
  });

  // Close modal
  closeBtn.addEventListener("click", () => {
    modal.classList.remove("active");
    document.body.style.overflow = "auto";
  });

  // Close on outside click
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.remove("active");
      document.body.style.overflow = "auto";
    }
  });

});


/* ================= CREATE POST MODAL ================= */
function initCreatePost() {
    const modal = document.getElementById("createPostModal");

    document.getElementById("headerCreateBtn")?.addEventListener("click", open);
    document.getElementById("sectionCreateBtn")?.addEventListener("click", open);
    document.getElementById("closeCreateModal")?.addEventListener("click", close);
    document.getElementById("cancelCreateBtn")?.addEventListener("click", close);

    function open() {
        modal.classList.add("active");
        document.body.style.overflow = "hidden";
    }

    function close() {
        modal.classList.remove("active");
        document.body.style.overflow = "";
    }
}
